package com.acertainsupplychain.business;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Set;

import com.acertainsupplychain.exception.InvalidItemException;
import com.acertainsupplychain.exception.OrderProcessingException;
import com.acertainsupplychain.interfaces.ItemSupplier;

public class CertainItemSupplier implements ItemSupplier {
    private static CertainItemSupplier instance;
    private static Map<Integer, ItemQuantity> itemMap;
    private static Integer supplierId;
    
    public synchronized static CertainItemSupplier getInstance() {
        if (instance == null) {
                instance = new CertainItemSupplier();
                itemMap = new HashMap<Integer, ItemQuantity>();
        }
        return instance;
    }
    
    @Override
    public void executeStep(OrderStep step) throws OrderProcessingException {
        if (step.getSupplierId() == supplierId) {
            Map<Integer, ItemQuantity> tmp = new HashMap<Integer, ItemQuantity>();
            tmp.putAll(itemMap);
            for (ItemQuantity i : step.getItems()) {
                Integer id = i.getItemId();
                if (tmp.containsKey(id)) {
                    Integer quantity = tmp.get(id).getQuantity() + i.getQuantity();
                    ItemQuantity item = new ItemQuantity(id, quantity);
                    tmp.put(id, item);
                } else {
                    throw new OrderProcessingException();
                }
            }
            itemMap = tmp;
        } else {
            throw new OrderProcessingException();
        }
    }

    @Override
    public List<ItemQuantity> getOrdersPerItem(Set<Integer> itemIds)
            throws InvalidItemException {
        List<ItemQuantity> items = new ArrayList<ItemQuantity>();
        for (Integer i : itemIds) {
            try {
                items.add(itemMap.get(i));
            } catch (Exception e) {
                throw new InvalidItemException();
            }
        }
        return items;
    }
}